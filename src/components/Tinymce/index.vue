<template>
    <div class="tinymce-container editor-container">
        <textarea class="tinymce-textarea"
            id="tinymceId"></textarea>
        <div class="editor-custom-btn-container">
            <editorImage color="#20a0ff"
                class="editor-upload-btn"
                @successCBK="imageSuccessCBK"></editorImage>
        </div>
    </div>
</template>

<script>
import editorImage from './components/editorImage'

export default {
    name: 'tinymce',
    components: { editorImage },
    props: {
        value: {
            type: String,
            default: ''
        },
        toolbar: {
            type: Array,
            required: false,
            default() {
                return ['removeformat undo redo |  bullist numlist | outdent indent | forecolor | fullscreen code', 'bold italic blockquote | h2 p  media link | alignleft aligncenter alignright  ']
            }
        },
        menubar: {
            default: ''
        },
        height: {
            type: Number,
            required: false,
            default: 360
        }
    },
    data() {
        return {
            hasChange: false,
            hasInit: false,
        }
    },
    watch: {
        value(val) {
            if (!this.hasChange && this.hasInit) {
                this.$nextTick(() => window.tinymce.get('tinymceId').setContent(val))
            }
        }
    },
    mounted() {
        this.initTinymce()
    },
    activated() {
        this.initTinymce()
    },
    deactivated() {
        this.destroyTinymce()
    },
    methods: {
        initTinymce() {
            const _this = this
            window.tinymce.init({
                selector: '#tinymceId',
                height: this.height,
                body_class: 'panel-body ',
                object_resizing: false,
                toolbar: this.toolbar,
                menubar: this.menubar,
                plugins: 'advlist,autolink,code,paste,textcolor, colorpicker,fullscreen,link,lists,media,wordcount, imagetools ',
                // language: 'zh_CN',
                // language_url: 'http://cdn.masterjoy.top/zh_CN.js',
                forced_root_block: '',
                end_container_on_empty_block: true,
                powerpaste_word_import: 'clean',
                code_dialog_height: 450,
                code_dialog_width: 1000,
                advlist_bullet_styles: 'square',
                advlist_number_styles: 'default',
                imagetools_cors_hosts: ['wpimg.wallstcn.com', 'wallstreetcn.com'],
                imagetools_toolbar: 'watermark',
                default_link_target: '_blank',
                link_title: false,
                init_instance_callback: editor => {
                    if (_this.value) {
                        editor.setContent(_this.value)
                    }
                    _this.hasInit = true
                    editor.on('NodeChange Change KeyUp', () => {
                        this.hasChange = true
                        this.$emit('input', editor.getContent({ format: 'raw' }))
                    })
                }
                // 整合七牛上传
                // images_dataimg_filter(img) {
                //   setTimeout(() => {
                //     const $image = $(img);
                //     $image.removeAttr('width');
                //     $image.removeAttr('height');
                //     if ($image[0].height && $image[0].width) {
                //       $image.attr('data-wscntype', 'image');
                //       $image.attr('data-wscnh', $image[0].height);
                //       $image.attr('data-wscnw', $image[0].width);
                //       $image.addClass('wscnph');
                //     }
                //   }, 0);
                //   return img
                // },
                // images_upload_handler(blobInfo, success, failure, progress) {
                //   progress(0);
                //   const token = _this.$store.getters.token;
                //   getToken(token).then(response => {
                //     const url = response.data.qiniu_url;
                //     const formData = new FormData();
                //     formData.append('token', response.data.qiniu_token);
                //     formData.append('key', response.data.qiniu_key);
                //     formData.append('file', blobInfo.blob(), url);
                //     upload(formData).then(() => {
                //       success(url);
                //       progress(100);
                //     })
                //   }).catch(err => {
                //     failure('出现未知问题，刷新页面，或者联系程序员')
                //     console.log(err);
                //   });
                // },
            })
        },
        destroyTinymce() {
            if (window.tinymce.get('tinymceId')) {
                window.tinymce.get('tinymceId').destroy()
            }
        },
        setContent(value) {
            window.tinymce.get('tinymceId').setContent(value)
        },
        getContent() {
            window.tinymce.get('tinymceId').getContent()
        },
        imageSuccessCBK(arr) {
            arr.forEach(v => {
                window.tinymce.get('tinymceId').insertContent(`<img class="wscnph" src="${v.url}" >`)
            })
        }
    },
    destroyed() {
        this.destroyTinymce()
    }
}
</script>

<style scoped>
.tinymce-container {
  position: relative;
}
.tinymce-textarea {
  visibility: hidden;
  z-index: -1;
}
.editor-custom-btn-container {
  position: absolute;
  right: 15px;
  /*z-index: 2005;*/
  top: 18px;
}
.editor-upload-btn {
  display: inline-block;
}
</style>
